# Hirundo 静的サイトジェネレーター - 問題点一覧

## 修正済みの問題 ✅

### セキュリティ関連
1. **SSRF攻撃の脆弱性** - `Sources/HirundoCore/Models/Config.swift:622-624`
   - ✅ プライベートIPアドレス、メタデータサービスエンドポイントをブロック

2. **CSRF保護の欠如** - `Sources/HirundoCore/DevelopmentServer.swift:131-157`
   - ✅ WebSocket接続にCSRFトークン実装

3. **暗号的に安全でないトークン生成** - `Sources/HirundoCore/DevelopmentServer.swift:604-618`
   - ✅ SecRandomCopyBytesを使用した安全な実装

4. **XSS脆弱性** - `Sources/HirundoCore/SiteGenerator.swift:348-398`
   - ✅ テンプレート変数の完全なサニタイゼーション

5. **DoS攻撃への脆弱性**
   - ✅ `/auth-token`エンドポイントにレート制限実装

6. **メモリリークの可能性** - `Sources/HirundoCore/TemplateEngine.swift:48-135`
   - ✅ キャッシュサイズ制限とTTL、LRU削除を実装

### コード品質
7. **重要なセキュリティテストが無効化** - `Tests/HirundoTests/SecurityTests.swift:288-297`
   - ✅ XSSテストを修正し有効化

8. **依存性注入の不足**
   - ✅ FileManagerの依存性注入を実装

9. **エラーメッセージの改善余地**
   - ✅ ユーザーフレンドリーなエラーメッセージと解決策の提案を実装

---

## 未修正の問題 ⚠️

### 🚨 重大 (Critical) - 即座の対応が必要

#### 1. テンプレートキャッシュの競合状態
- **場所**: `Sources/HirundoCore/TemplateEngine.swift:124-141`
- **問題**: キャッシュクリーンアップタイマーと読み書き操作が適切に同期されていない
- **影響**: アプリケーションのクラッシュ、不整合なレンダリング結果
- **解決案**: タイマー操作を同じキューで実行、または別の同期メカニズムを使用

#### 2. プラグインサンドボックス未実装
- **場所**: `Sources/HirundoCore/Plugins/PluginManager.swift:452-479`
- **問題**: セキュリティコンテキストは定義されているが、実際の制限がTODOコメントのまま
- **影響**: 悪意のあるプラグインがシステムに無制限にアクセス可能
- **解決案**: SecureFileManagerの実装を完成させ、プラグイン実行を制限

#### 3. FileHandleリソースリーク
- **場所**: `Sources/HirundoCore/DevelopmentServer.swift:616-627`
- **問題**: ビルドエラーログ記録時にFileHandleが適切に閉じられない
- **影響**: ファイルディスクリプタの枯渇、システムの不安定化
- **解決案**: defer文を使用した確実なリソース解放

#### 4. シンボリックリンク攻撃の脆弱性
- **場所**: 複数のファイル操作箇所
- **問題**: ファイル操作時にシンボリックリンクの検証が不足
- **影響**: パストラバーサル攻撃、権限外のファイルアクセス
- **解決案**: すべてのファイル操作前にシンボリックリンクチェックを追加

### ⚠️ 高優先度 - 早急な対応が推奨

#### 5. FSEventsのメモリリーク
- **場所**: `Sources/HirundoCore/FSEventsWrapper.swift:13-16`
- **問題**: コールバッククロージャがselfを強参照し、循環参照を作成
- **影響**: 長時間実行される開発サーバーでのメモリリーク
- **解決案**: [weak self]キャプチャリストの使用

#### 6. スレッド同期の問題
- **場所**: `Sources/HirundoCore/HotReloadManager.swift:32-114`
- **問題**: 複数の並行キューがファイル変更を適切な協調なしに処理
- **影響**: 競合状態、不整合なリロード動作
- **解決案**: アクターパターンまたは適切な同期プリミティブの使用

#### 7. 単一責任原則違反
- **場所**: `Sources/HirundoCore/SiteGenerator.swift` (1200行以上)
- **問題**: 1つのクラスがサイト生成、ファイルI/O、テンプレートレンダリング、セキュリティ検証を担当
- **影響**: テスト、保守、デバッグが困難
- **解決案**: 責任ごとに別々のクラスに分割

#### 8. プラグインリソース制限の未実装
- **問題**: プラグイン実行の監視は存在するが、実際の制限が不完全
- **影響**: 悪意のあるプラグインが無制限にリソースを消費可能
- **解決案**: タイムアウト、メモリ制限、CPU制限の実装

### 📋 中優先度 - 計画的な対応

#### 9. パスサニタイゼーションの性能問題
- **問題**: 同じパスが繰り返しサニタイズされ、キャッシュされない
- **影響**: 大規模サイトでのパフォーマンス低下
- **解決案**: サニタイズ結果のキャッシング実装

#### 10. 大きなファイルのメモリ問題
- **問題**: Markdownファイル全体をメモリに読み込み、ストリーミングサポートなし
- **影響**: 大きなドキュメントでメモリ不足エラー
- **解決案**: ストリーミング処理の実装

#### 11. 設定検証の不足
- **問題**: プラグイン設定が無効な組み合わせを作成可能、実行時まで検出されない
- **影響**: 実行時エラー、デバッグの困難さ
- **解決案**: 包括的な設定検証の実装

#### 12. タイマークリーンアップのエッジケース
- **問題**: deinitでのタイマー無効化が異常な状態でハングする可能性
- **影響**: シャットダウン時のアプリケーションハング
- **解決案**: タイムアウト付きクリーンアップの実装

#### 13. テンプレートエンジンの結合
- **問題**: TemplateEngineがSiteモデル設定に密結合
- **影響**: テストとコンポーネントの再利用が困難
- **解決案**: インターフェースベースの設計に変更

### 📝 ドキュメントと互換性の問題

#### 14. ドキュメントの不足
- **問題**: セキュリティクリティカルな関数のドキュメントが不足
- **影響**: 保守性の低下、誤用の可能性
- **解決案**: 包括的なAPIドキュメントの追加

#### 15. クロスプラットフォーム互換性
- **問題**: 大文字小文字を区別するファイルシステムとWindowsパス処理の問題
- **影響**: 異なるプラットフォームでの動作不良
- **解決案**: プラットフォーム固有の処理の実装

---

## 推奨事項

### 即座に対処すべき項目
1. テンプレートキャッシュの競合状態の修正
2. プラグインサンドボックスの完全実装
3. FileHandleリソースリークの修正
4. シンボリックリンク攻撃の防止

### 短期的に対処すべき項目
1. FSEventsのメモリリーク修正
2. スレッド同期の改善
3. SiteGeneratorクラスのリファクタリング
4. プラグインリソース制限の実装

### 長期的な改善項目
1. パフォーマンス最適化（キャッシング、ストリーミング）
2. 包括的なドキュメント作成
3. クロスプラットフォーム対応の強化
4. アーキテクチャの改善（疎結合、テスタビリティ）

---

## 総評

Hirundoは全体的によく設計されたシステムですが、以下の点で改善が必要です：

- **セキュリティ**: 基本的な対策は実装されているが、プラグインサンドボックスなど重要な機能が未完成
- **並行処理**: 複数の競合状態とメモリリークが存在
- **アーキテクチャ**: 単一責任原則の違反など、設計上の問題
- **リソース管理**: 適切なクリーンアップの欠如

これらの問題を体系的に修正することで、より堅牢で保守性の高いシステムになるでしょう。

**優先度スコア**:
- セキュリティ: 7/10
- 安定性: 6/10
- パフォーマンス: 7/10
- 保守性: 6/10

特に重大カテゴリの4項目は、本番環境での使用前に必ず修正が必要です。